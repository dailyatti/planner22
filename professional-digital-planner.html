<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Professional Digital Planner 2025 - Advanced productivity system with mood tracking, calendar integration, analytics, and premium features">
  <meta name="theme-color" content="#6366f1">
  <title>Digital Planner Pro 2025 🌟</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" defer></script>

  <style>
    /* ========= CSS Variables & Root Styles ========= */
    :root {
      /* Color Palette - Professional & Modern */
      --primary-50: #eef2ff;
      --primary-100: #e0e7ff;
      --primary-200: #c7d2fe;
      --primary-300: #a5b4fc;
      --primary-400: #818cf8;
      --primary-500: #6366f1;
      --primary-600: #4f46e5;
      --primary-700: #4338ca;
      --primary-800: #3730a3;
      --primary-900: #312e81;
      
      --secondary-50: #f0fdf4;
      --secondary-100: #dcfce7;
      --secondary-200: #bbf7d0;
      --secondary-300: #86efac;
      --secondary-400: #4ade80;
      --secondary-500: #22c55e;
      --secondary-600: #16a34a;
      --secondary-700: #15803d;
      --secondary-800: #166534;
      --secondary-900: #14532d;
      
      --accent-50: #fef3c7;
      --accent-100: #fde68a;
      --accent-200: #fcd34d;
      --accent-300: #fbbf24;
      --accent-400: #f59e0b;
      --accent-500: #d97706;
      --accent-600: #b45309;
      --accent-700: #92400e;
      --accent-800: #78350f;
      --accent-900: #451a03;

      /* Neutrals */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      /* System Colors */
      --success: var(--secondary-500);
      --warning: var(--accent-500);
      --error: #ef4444;
      --info: var(--primary-500);

      /* Spacing & Layout */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;

      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --radius-xl: 1.5rem;
      --radius-2xl: 2rem;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
      --shadow-inner: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

      /* Typography */
      --font-family-display: 'Playfair Display', serif;
      --font-family-body: 'Inter', system-ui, -apple-system, sans-serif;

      /* Background Gradients */
      --gradient-primary: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
      --gradient-secondary: linear-gradient(135deg, var(--secondary-500) 0%, var(--secondary-700) 100%);
      --gradient-accent: linear-gradient(135deg, var(--accent-400) 0%, var(--accent-600) 100%);
      --gradient-bg: linear-gradient(135deg, var(--gray-50) 0%, var(--primary-50) 100%);
      --gradient-card: linear-gradient(145deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    }

    /* ========= Base Styles ========= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family-body);
      line-height: 1.6;
      color: var(--gray-800);
      background: var(--gradient-bg);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ========= Navigation ========= */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px) saturate(160%);
      border-bottom: 1px solid var(--gray-200);
      transition: var(--transition);
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-4) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      text-decoration: none;
    }

    .nav-logo {
      width: 48px;
      height: 48px;
      background: var(--gradient-primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
    }

    .nav-logo:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-xl);
    }

    .nav-title {
      font-family: var(--font-family-display);
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--primary-700);
      letter-spacing: -0.025em;
    }

    .nav-subtitle {
      font-size: 0.875rem;
      color: var(--gray-500);
      font-weight: 500;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .nav-toggle {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: var(--space-3) var(--space-5);
      border-radius: var(--radius-lg);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    .nav-toggle:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .nav-menu {
      position: absolute;
      top: calc(100% + var(--space-2));
      right: var(--space-6);
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      padding: var(--space-6);
      min-width: 320px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: var(--transition);
      border: 1px solid var(--gray-200);
    }

    .nav-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    .menu-item {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
    }

    .menu-item:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
      transform: translateY(-2px);
    }

    /* ========= Main Layout ========= */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-8) var(--space-6);
    }

    .hero-section {
      text-align: center;
      margin-bottom: var(--space-12);
      position: relative;
    }

    .hero-title {
      font-family: var(--font-family-display);
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-weight: 700;
      color: var(--primary-700);
      margin-bottom: var(--space-4);
      letter-spacing: -0.025em;
      position: relative;
    }

    .hero-subtitle {
      font-size: 1.25rem;
      color: var(--gray-600);
      font-weight: 500;
      margin-bottom: var(--space-8);
    }

    .date-selector {
      background: white;
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
      margin-bottom: var(--space-10);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-6);
      flex-wrap: wrap;
      border: 1px solid var(--gray-200);
    }

    .date-input-group {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .date-input {
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-800);
      background: var(--gray-50);
      transition: var(--transition);
      min-width: 160px;
    }

    .date-input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
      background: white;
    }

    .date-display {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--primary-700);
      padding: var(--space-3) var(--space-5);
      background: var(--primary-100);
      border-radius: var(--radius-lg);
    }

    /* ========= Grid Layout ========= */
    .planner-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: var(--space-8);
      margin-bottom: var(--space-12);
    }

    .card {
      background: var(--gradient-card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0.7;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-2xl);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--gray-200);
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .card-icon {
      width: 40px;
      height: 40px;
      background: var(--gradient-primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.125rem;
    }

    .card-badge {
      background: var(--primary-100);
      color: var(--primary-700);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* ========= Form Elements ========= */
    .input-group {
      margin-bottom: var(--space-5);
    }

    .input-label {
      display: block;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      font-size: 0.875rem;
    }

    .input {
      width: 100%;
      padding: var(--space-4);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.8);
    }

    .input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px var(--primary-100);
      background: white;
    }

    .textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      border: none;
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: var(--space-2) var(--space-3);
      font-size: 0.75rem;
    }

    .btn-lg {
      padding: var(--space-4) var(--space-8);
      font-size: 1rem;
    }

    /* ========= Todo List ========= */
    .todo-list {
      list-style: none;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      border: 1px solid var(--gray-200);
      transition: var(--transition);
    }

    .todo-item:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateX(4px);
    }

    .todo-checkbox {
      width: 20px;
      height: 20px;
      border-radius: var(--radius);
      border: 2px solid var(--gray-400);
      background: white;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .todo-checkbox:checked {
      background: var(--primary-500);
      border-color: var(--primary-500);
    }

    .todo-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .todo-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: var(--gray-800);
      outline: none;
    }

    .todo-input.completed {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .todo-actions {
      display: flex;
      gap: var(--space-2);
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius);
      color: var(--gray-500);
      transition: var(--transition);
    }

    .icon-btn:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    /* ========= Priority Cards ========= */
    .priority-item {
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      border-left: 4px solid var(--gray-300);
      transition: var(--transition);
    }

    .priority-item.high { border-left-color: var(--error); }
    .priority-item.medium { border-left-color: var(--warning); }
    .priority-item.low { border-left-color: var(--success); }

    .priority-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-2);
    }

    .priority-label.high { color: var(--error); }
    .priority-label.medium { color: var(--warning); }
    .priority-label.low { color: var(--success); }

    /* ========= Water Tracker ========= */
    .water-tracker {
      text-align: center;
    }

    .water-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }

    .water-control-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: rgba(255, 255, 255, 0.8);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
    }

    .water-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .water-glass {
      width: 50px;
      height: 60px;
      border: 3px solid var(--primary-400);
      border-radius: 8px 8px 12px 12px;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
      background: white;
      overflow: hidden;
    }

    .water-glass:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .water-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
      transition: height 0.3s ease;
    }

    .water-glass.filled .water-fill {
      height: 100%;
    }

    .water-progress {
      background: var(--gray-200);
      height: 12px;
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: var(--space-4);
    }

    .water-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa 0%, #3b82f6 100%);
      transition: width 0.3s ease;
      border-radius: var(--radius-full);
    }

    .water-stats {
      color: var(--gray-600);
      font-weight: 600;
    }

    /* ========= Mood Tracker ========= */
    .mood-tracker {
      text-align: center;
    }

    .mood-emotions {
      display: flex;
      justify-content: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }

    .mood-emotion {
      width: 60px;
      height: 60px;
      border: 3px solid var(--gray-300);
      border-radius: var(--radius-xl);
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }

    .mood-emotion:hover {
      transform: scale(1.1);
      border-color: var(--primary-400);
    }

    .mood-emotion.active {
      border-color: var(--primary-500);
      background: var(--primary-50);
      transform: scale(1.15);
      box-shadow: var(--shadow-lg);
    }

    .mood-scale {
      margin-bottom: var(--space-4);
    }

    .mood-slider {
      width: 100%;
      max-width: 400px;
      height: 8px;
      border-radius: var(--radius-full);
      background: linear-gradient(90deg, #fecaca 0%, #fed7aa 25%, #fde68a 50%, #d9f99d 75%, #bbf7d0 100%);
      outline: none;
      appearance: none;
      cursor: pointer;
    }

    .mood-slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--primary-500);
      box-shadow: var(--shadow-lg);
      cursor: pointer;
    }

    .mood-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--primary-500);
      box-shadow: var(--shadow-lg);
      cursor: pointer;
    }

    .mood-value {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--primary-700);
      margin-top: var(--space-2);
    }

    /* ========= Calendar ========= */
    .calendar-container {
      background: white;
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }

    .calendar-nav {
      background: var(--gray-100);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-lg);
      padding: var(--space-2);
      cursor: pointer;
      transition: var(--transition);
    }

    .calendar-nav:hover {
      background: var(--gray-200);
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-800);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--space-1);
    }

    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      color: var(--gray-600);
      padding: var(--space-2);
      font-size: 0.875rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      position: relative;
      min-height: 40px;
    }

    .calendar-day:hover {
      background: var(--gray-100);
    }

    .calendar-day.today {
      background: var(--primary-500);
      color: white;
      font-weight: 700;
    }

    .calendar-day.selected {
      background: var(--primary-100);
      color: var(--primary-700);
      font-weight: 700;
    }

    .calendar-day.other-month {
      color: var(--gray-400);
    }

    .calendar-day.period {
      background: #fecaca;
      color: #dc2626;
    }

    .calendar-day.fertile {
      background: #d9f99d;
      color: #16a34a;
    }

    .calendar-day.ovulation {
      background: #fde68a;
      color: #d97706;
    }

    /* ========= Responsive Design ========= */
    @media (max-width: 1024px) {
      .planner-grid {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: var(--space-6);
      }
      
      .nav-container {
        padding: var(--space-3) var(--space-4);
      }
      
      .main-container {
        padding: var(--space-6) var(--space-4);
      }
    }

    @media (max-width: 768px) {
      .planner-grid {
        grid-template-columns: 1fr;
      }
      
      .date-selector {
        flex-direction: column;
        gap: var(--space-4);
      }
      
      .nav-menu {
        left: var(--space-4);
        right: var(--space-4);
        min-width: unset;
      }
      
      .menu-grid {
        grid-template-columns: 1fr;
      }
      
      .water-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .mood-emotions {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: var(--space-6);
      }
      
      .hero-title {
        font-size: 2rem;
      }
      
      .water-controls {
        flex-direction: column;
      }
      
      .calendar-day {
        min-height: 35px;
        font-size: 0.875rem;
      }
    }

    /* ========= Print Styles ========= */
    @media print {
      body {
        background: white !important;
      }
      
      .navbar,
      .nav-menu,
      .btn,
      .todo-actions,
      .water-controls {
        display: none !important;
      }
      
      .card {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid var(--gray-300) !important;
        background: white !important;
      }
      
      .planner-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* ========= Animation Classes ========= */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    .slide-up {
      animation: slideUp 0.3s ease-out;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ========= Toast Notifications ========= */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--gradient-primary);
      color: white;
      padding: var(--space-4) var(--space-6);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      z-index: 1000;
      transform: translateX(100%);
      transition: var(--transition);
      font-weight: 600;
    }

    .toast.show {
      transform: translateX(0);
    }

    /* ========= Full Width Cards ========= */
    .card-full {
      grid-column: 1 / -1;
    }

    /* ========= Notes Section ========= */
    .notes-toolbar {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }

    .notes-stats {
      margin-top: var(--space-4);
      display: flex;
      justify-content: space-between;
      font-size: 0.875rem;
      color: var(--gray-500);
    }

    /* ========= Cycle Tracker Enhancements ========= */
    .cycle-controls {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }

    .cycle-legend {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 0.875rem;
      color: var(--gray-600);
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-300);
    }

    /* ========= Motivation Section ========= */
    .motivation-content {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: var(--space-8);
      align-items: center;
      border: 1px solid rgba(99, 102, 241, 0.15);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
    }

    .motivation-quote {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-2xl);
      padding: var(--space-6);
      box-shadow: var(--shadow);
    }

    .quote-text {
      font-family: var(--font-family-display);
      font-size: clamp(1.25rem, 2.5vw, 1.75rem);
      line-height: 1.4;
      font-weight: 600;
      background: linear-gradient(135deg, var(--primary-700), var(--primary-500));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: var(--space-3);
    }

    .quote-author {
      color: var(--gray-600);
      font-weight: 600;
    }

    .progress-wrapper {
      position: relative;
      width: 160px;
      height: 160px;
      margin: 0 auto;
    }

    .progress-ring {
      width: 160px;
      height: 160px;
      filter: drop-shadow(0 8px 16px rgba(99,102,241,0.2));
    }

    .progress-ring__progress {
      transition: stroke-dashoffset var(--transition), stroke 300ms ease;
    }

    .progress-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: var(--primary-700);
      font-size: 1.25rem;
    }

    .affirmation-box {
      background: var(--primary-50);
      border: 1px solid var(--primary-200);
      border-radius: var(--radius-xl);
      padding: var(--space-5);
      box-shadow: var(--shadow-inner);
    }

    #affirmationText {
      font-weight: 700;
      color: var(--primary-700);
      margin-bottom: var(--space-3);
    }

    .motivation-actions {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    /* Confetti */
    .confetti {
      position: fixed;
      top: -10px;
      width: 10px;
      height: 14px;
      opacity: 0.9;
      border-radius: 2px;
      z-index: 2000;
      animation: confetti-fall 1200ms ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0.9; }
    }

    /* Responsive for Motivation */
    @media (max-width: 1024px) {
      .motivation-content {
        grid-template-columns: 1fr;
      }
    }

    /* Motivation Pro additions */
    .motivation-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }

    .streak-pill, .wins-pill {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-full);
      font-weight: 700;
      font-size: 0.875rem;
      box-shadow: var(--shadow);
      background: white;
      border: 1px solid var(--gray-200);
      color: var(--gray-700);
    }

    .streak-pill i { color: #f59e0b; }
    .wins-pill i { color: #22c55e; }

    .custom-aff-controls {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-3);
      flex-wrap: wrap;
    }

    .custom-aff-list {
      margin-top: var(--space-3);
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-2);
      max-height: 160px;
      overflow: auto;
    }

    .custom-aff-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      background: rgba(255,255,255,0.8);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
    }

    /* ========= Cycle Forecast & Probability ========= */
    .cycle-forecast {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      color: var(--gray-700);
      font-weight: 600;
    }

    .cycle-chart {
      margin-top: var(--space-4);
      padding: var(--space-3);
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
    }

    .cycle-chart canvas {
      width: 100%;
      max-height: 220px;
    }

    /* ========= Motivation Modal ========= */
    .motivation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }

    .motivation-modal.show {
      display: flex !important;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .motivation-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .motivation-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--gray-200);
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
    }

    .motivation-header h3 {
      margin: 0;
      color: var(--primary-700);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .motivation-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--gray-500);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .motivation-close:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .motivation-body {
      padding: 24px;
    }

    .motivation-message {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--gray-700);
      margin-bottom: 24px;
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .motivation-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .motivation-actions .btn {
      min-width: 100px;
    }

    /* Cycle-based motivation styling */
    .motivation-cycle {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-left: 4px solid #f59e0b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .motivation-cycle h4 {
      margin: 0 0 8px 0;
      color: #92400e;
      font-size: 1rem;
    }

    .motivation-cycle p {
      margin: 0;
      color: #78350f;
      font-size: 0.9rem;
    }

    .motivation-text {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--gray-700);
      text-align: center;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 8px;
      border: 1px solid var(--gray-200);
    }

    /* ========= Calendar Day Editor ========= */
    .calendar-day.has-note::after {
      content: '📝';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .day-editor-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 9998;
      backdrop-filter: blur(4px);
    }

    .day-editor-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }

    .day-editor-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: modalSlideIn 0.3s ease-out;
    }

    .day-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--gray-200);
      background: linear-gradient(135deg, var(--secondary-50), var(--secondary-100));
    }

    .day-editor-header h3 {
      margin: 0;
      color: var(--secondary-700);
      font-size: 1.25rem;
      font-weight: 600;
    }

    .day-editor-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--gray-500);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .day-editor-close:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .day-editor-body {
      padding: 24px;
    }

    .day-editor-date {
      text-align: center;
      margin-bottom: 20px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .day-editor-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .day-editor-textarea:focus {
      outline: none;
      border-color: var(--primary-500);
    }

    .day-editor-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .day-editor-actions .btn {
      min-width: 100px;
    }

    .calendar-day.prob-high { box-shadow: inset 0 0 0 2px #16a34a; }
    .calendar-day.prob-medium { box-shadow: inset 0 0 0 2px #f59e0b; }
    .calendar-day.prob-low { box-shadow: inset 0 0 0 2px #9ca3af; }

    @media (max-width: 768px) {
      .motivation-content {
        grid-template-columns: 1fr;
        gap: var(--space-6);
      }
      .mood-emotions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        justify-items: center;
      }
    }

    /* ========= Todo Schedule Modal ========= */
    .schedule-modal { position: fixed; inset: 0; display: none; background: rgba(0,0,0,.5); z-index: 9998; backdrop-filter: blur(4px); }
    .schedule-modal.show { display: flex; align-items: center; justify-content: center; animation: fadeIn .2s ease-out; }
    .schedule-content { background: #fff; border-radius: 14px; width: 90%; max-width: 440px; box-shadow: 0 10px 30px rgba(0,0,0,.15); overflow: hidden; }
    .schedule-header { display:flex; align-items:center; justify-content: space-between; padding: 16px 18px; border-bottom: 1px solid var(--gray-200); background: linear-gradient(135deg, var(--primary-50), var(--secondary-50)); }
    .schedule-header h3 { margin:0; font-size: 1.1rem; color: var(--primary-700); }
    .schedule-close { background:none; border:none; font-size: 1.1rem; color: var(--gray-600); cursor:pointer; padding:6px 8px; border-radius:8px; }
    .schedule-close:hover { background: var(--gray-100); }
    .schedule-body { padding: 18px; display: grid; gap: 12px; }
    .schedule-row { display:flex; gap: 10px; align-items: center; }
    .schedule-row label { min-width: 90px; color: var(--gray-700); font-weight: 600; }
    .schedule-row input[type="date"], .schedule-row input[type="time"] { flex:1; padding:8px 10px; border:1px solid var(--gray-300); border-radius:8px; }
    .schedule-actions { display:flex; gap: 10px; justify-content: flex-end; padding: 0 18px 18px; }
    .schedule-actions .btn { min-width: 110px; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="#" class="nav-brand">
        <div class="nav-logo">🌟</div>
        <div>
          <div class="nav-title">Digital Planner Pro</div>
          <div class="nav-subtitle">Professional Productivity System</div>
        </div>
      </a>
      
      <div class="nav-actions">
        <button class="nav-toggle" id="navToggle">
          <i class="fas fa-bars"></i>
          <span>Menu</span>
        </button>
      </div>
      
      <div class="nav-menu" id="navMenu">
        <div class="menu-grid">
          <div class="menu-item" id="exportPDF">
            <i class="fas fa-file-pdf" style="color: var(--error);"></i>
            <span>Export PDF</span>
          </div>
          <div class="menu-item" id="exportPNG">
            <i class="fas fa-image" style="color: var(--success);"></i>
            <span>Save Image</span>
          </div>
          <div class="menu-item" id="printPlanner">
            <i class="fas fa-print" style="color: var(--gray-600);"></i>
            <span>Print</span>
          </div>
          <div class="menu-item" id="savePlanner">
            <i class="fas fa-save" style="color: var(--primary-500);"></i>
            <span>Save</span>
          </div>
          <div class="menu-item" id="resetPlanner">
            <i class="fas fa-refresh" style="color: var(--warning);"></i>
            <span>Reset</span>
          </div>
          <div class="menu-item" id="analytics">
            <i class="fas fa-chart-line" style="color: var(--info);"></i>
            <span>Analytics</span>
          </div>
          <div class="menu-item" id="exportAll">
            <i class="fas fa-download" style="color: var(--primary-600);"></i>
            <span>Export All</span>
          </div>
          <div class="menu-item" id="resetAll">
            <i class="fas fa-trash" style="color: var(--error);"></i>
            <span>Reset All</span>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-container" id="plannerContent">
    <!-- Hero Section -->
    <section class="hero-section">
      <h1 class="hero-title">Your Perfect Day Planner</h1>
      <p class="hero-subtitle">Design your ideal day with advanced productivity tools and insights</p>
    </section>

    <!-- Date Selection -->
    <section class="date-selector">
      <div class="date-input-group">
        <label for="plannerDate" class="input-label">Select Date:</label>
        <input type="date" id="plannerDate" class="date-input">
      </div>
      <div class="date-display" id="dateDisplay">Today</div>
    </section>

    <!-- Main Grid -->
    <div class="planner-grid">
      <!-- Daily Tasks -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-tasks"></i></div>
            Daily Tasks
          </h2>
          <div class="card-badge" id="todoProgress">0/0</div>
        </div>
        <ul class="todo-list" id="todoList"></ul>
        <button class="btn btn-primary" id="addTodo">
          <i class="fas fa-plus"></i>
          Add Task
        </button>
      </article>

      <!-- Top Priorities -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-star"></i></div>
            Top Priorities
          </h2>
        </div>
        <div class="priority-item high">
          <div class="priority-label high">High Priority</div>
          <input type="text" class="input" id="priority1" placeholder="Most important task of the day" data-key="priority1">
        </div>
        <div class="priority-item medium">
          <div class="priority-label medium">Medium Priority</div>
          <input type="text" class="input" id="priority2" placeholder="Second most important task" data-key="priority2">
        </div>
        <div class="priority-item low">
          <div class="priority-label low">Low Priority</div>
          <input type="text" class="input" id="priority3" placeholder="Third most important task" data-key="priority3">
        </div>
      </article>

      <!-- Daily Schedule -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-clock"></i></div>
            Daily Schedule
          </h2>
        </div>
        <div class="input-group">
          <label class="input-label">Morning (6:00 - 12:00)</label>
          <input type="text" class="input" id="morning" placeholder="Morning routine, breakfast, early tasks..." data-key="morning">
        </div>
        <div class="input-group">
          <label class="input-label">Afternoon (12:00 - 18:00)</label>
          <input type="text" class="input" id="afternoon" placeholder="Work, lunch, main activities..." data-key="afternoon">
        </div>
        <div class="input-group">
          <label class="input-label">Evening (18:00 - 22:00)</label>
          <input type="text" class="input" id="evening" placeholder="Dinner, relaxation, evening routine..." data-key="evening">
        </div>
      </article>

      <!-- Meals Planner -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-utensils"></i></div>
            Meal Planning
          </h2>
        </div>
        <div class="input-group">
          <label class="input-label">Breakfast</label>
          <input type="text" class="input" id="breakfast" placeholder="What will you have for breakfast?" data-key="breakfast">
        </div>
        <div class="input-group">
          <label class="input-label">Lunch</label>
          <input type="text" class="input" id="lunch" placeholder="What will you have for lunch?" data-key="lunch">
        </div>
        <div class="input-group">
          <label class="input-label">Dinner</label>
          <input type="text" class="input" id="dinner" placeholder="What will you have for dinner?" data-key="dinner">
        </div>
        <div class="input-group">
          <label class="input-label">Snacks</label>
          <input type="text" class="input" id="snacks" placeholder="Healthy snacks and treats" data-key="snacks">
        </div>
      </article>

      <!-- Water Tracker -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-tint"></i></div>
            Hydration Tracker
          </h2>
          <div class="card-badge" id="waterProgress">0/8 glasses</div>
        </div>
        <div class="water-tracker">
          <div class="water-controls">
            <div class="water-control-group">
              <label class="input-label">Daily Goal:</label>
              <input type="number" id="waterTarget" min="1" max="20" value="8" class="input" style="width: 80px;">
              <span>glasses</span>
            </div>
            <div class="water-control-group">
              <button class="btn btn-secondary btn-sm" id="waterDecrease">-</button>
              <span id="waterCurrent">0</span>
              <button class="btn btn-primary btn-sm" id="waterIncrease">+</button>
            </div>
          </div>
          <div class="water-grid" id="waterGrid"></div>
          <div class="water-progress">
            <div class="water-progress-bar" id="waterProgressBar"></div>
          </div>
          <div class="water-stats" id="waterStats">0 of 8 glasses completed</div>
          
          <!-- Daily Motivation Panel (persists globally) -->
          <div class="motivation-content" style="margin-top: var(--space-6);">
            <div class="motivation-topbar" style="grid-column: 1 / -1;">
              <div class="streak-pill" id="streakPill"><i class="fas fa-fire"></i><span>Streak: <strong id="streakValue">0</strong> days</span></div>
              <div class="wins-pill" id="winsPill"><i class="fas fa-check-circle"></i><span>Wins today: <strong id="winsValue">0</strong></span></div>
              <div style="display:flex; gap: var(--space-2);">
                <button class="btn btn-secondary btn-sm" id="shuffleAffirmations"><i class="fas fa-shuffle"></i> Shuffle</button>
                <button class="btn btn-secondary btn-sm" id="copyAffirmation"><i class="fas fa-copy"></i> Copy</button>
              </div>
            </div>
            <div class="motivation-quote">
              <div class="quote-text" id="quoteText">Start where you are. Use what you have. Do what you can.</div>
              <div class="quote-author" id="quoteAuthor">— Arthur Ashe</div>
            </div>
            <div class="progress-area" style="text-align: center;">
              <div class="progress-wrapper">
                <svg class="progress-ring" width="160" height="160">
                  <circle cx="80" cy="80" r="70" stroke="#e5e7eb" stroke-width="12" fill="none" />
                  <circle id="progressRingCircle" cx="80" cy="80" r="70" stroke="url(#grad)" stroke-width="12" fill="none"
                          stroke-linecap="round" transform="rotate(-90 80 80)" class="progress-ring__progress" />
                  <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#6366f1"/>
                      <stop offset="100%" stop-color="#22c55e"/>
                    </linearGradient>
                  </defs>
                </svg>
                <div class="progress-label" id="motivationProgressLabel">0%</div>
              </div>
              <div class="affirmation-box" style="margin-top: var(--space-4);">
                <div id="affirmationText">I choose focus, energy, and progress.</div>
                <div class="motivation-actions" style="margin-top: var(--space-3);">
                  <button class="btn btn-primary btn-sm" id="generateAffirmation"><i class="fas fa-sparkles"></i> New Affirmation</button>
                  <button class="btn btn-secondary btn-sm" id="nextQuote"><i class="fas fa-quote-right"></i> Next Quote</button>
                  <button class="btn btn-primary" id="showMotivation"><i class="fas fa-heart"></i> Get Motivated</button>
                  <button class="btn btn-secondary btn-sm" id="motivationCelebrate"><i class="fas fa-burst"></i> Celebrate</button>
                  <button class="btn btn-secondary btn-sm" onclick="console.log('Test button clicked'); const modal = document.getElementById('motivationModal'); modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; modal.classList.add('show');" style="background: #f59e0b;">
                    <i class="fas fa-bug"></i> Test Modal
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="console.log('Test day editor'); const modal = document.getElementById('dayEditorModal'); modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; modal.classList.add('show');" style="background: #06b6d4;">
                    <i class="fas fa-calendar-plus"></i> Test Day Editor
                  </button>
                </div>
                <div class="custom-aff-controls">
                  <input class="input" id="affInput" placeholder="Add your own affirmation..." style="flex:1; min-width: 220px;">
                  <button class="btn btn-primary btn-sm" id="addAffirmation"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div class="custom-aff-list" id="customAffList"></div>
              </div>
            </div>
          </div>
        </div>
      </article>

      <!-- Mood Tracker -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-heart"></i></div>
            Mood & Energy
          </h2>
        </div>
        <div class="mood-tracker">
          <p style="color: var(--gray-600); margin-bottom: var(--space-4);">How are you feeling today?</p>
          <div class="mood-emotions" id="moodEmotions"></div>
          <div class="mood-scale">
            <input type="range" class="mood-slider" id="moodSlider" min="1" max="10" value="5">
            <div class="mood-value" id="moodValue">5/10</div>
          </div>
          <div class="input-group">
            <label class="input-label">What's influencing your mood today?</label>
            <textarea class="input textarea" id="moodNotes" placeholder="Describe your feelings, energy levels, or what's affecting your mood..." data-key="moodNotes"></textarea>
          </div>
        </div>
      </article>

      

      <!-- Gratitude Journal -->
      <article class="card">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-heart"></i></div>
            Gratitude Journal
          </h2>
        </div>
        <div class="input-group">
          <label class="input-label">1. I'm grateful for...</label>
          <input type="text" class="input" id="gratitude1" placeholder="Something you're thankful for today" data-key="gratitude1">
        </div>
        <div class="input-group">
          <label class="input-label">2. I appreciate...</label>
          <input type="text" class="input" id="gratitude2" placeholder="Another thing you appreciate" data-key="gratitude2">
        </div>
        <div class="input-group">
          <label class="input-label">3. I'm blessed with...</label>
          <input type="text" class="input" id="gratitude3" placeholder="A third thing you're grateful for" data-key="gratitude3">
        </div>
      </article>

      <!-- Notes & Ideas -->
      <article class="card card-full">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-lightbulb"></i></div>
            Notes & Ideas
          </h2>
        </div>
        <div class="notes-toolbar">
          <button class="btn btn-secondary btn-sm" data-format="- [ ] ">Checklist</button>
          <button class="btn btn-secondary btn-sm" data-format="• ">Bullet Point</button>
          <button class="btn btn-secondary btn-sm" data-format="# ">Heading</button>
          <button class="btn btn-secondary btn-sm" data-format="**">Bold</button>
          <button class="btn btn-secondary btn-sm" id="exportNotes">Export TXT</button>
        </div>
        <textarea class="input textarea" id="notes" placeholder="Write your thoughts, ideas, insights, or anything that comes to mind..." data-key="notes" style="min-height: 200px;"></textarea>
        <div class="notes-stats">
          <span id="wordCount">0 words</span>
          <span id="charCount">0 characters</span>
        </div>
      </article>

      <!-- Advanced Calendar with Cycle Tracking -->
      <article class="card card-full">
        <div class="card-header">
          <h2 class="card-title">
            <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
            Advanced Calendar & Cycle Tracking
          </h2>
        </div>
        <div class="cycle-controls">
          <div class="input-group" style="margin-bottom: 0;">
            <label class="input-label">Last Period Start</label>
            <input type="date" class="input" id="lastPeriod" style="width: auto;">
          </div>
          <div class="input-group" style="margin-bottom: 0;">
            <label class="input-label">Cycle Length</label>
            <input type="number" class="input" id="cycleLength" min="20" max="40" value="28" style="width: 80px;">
            <span>days</span>
          </div>
          <div class="input-group" style="margin-bottom: 0;">
            <label class="input-label">Period Length</label>
            <input type="number" class="input" id="periodLength" min="1" max="10" value="5" style="width: 80px;">
            <span>days</span>
          </div>
          <button class="btn btn-primary" id="updateCycle">Update Cycle</button>
        </div>
        
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="calendar-nav" id="prevMonth">
              <i class="fas fa-chevron-left"></i>
            </button>
            <h3 class="calendar-title" id="calendarTitle">January 2025</h3>
            <button class="calendar-nav" id="nextMonth">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="cycle-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #fecaca;"></div>
              <span>Period Days</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #d9f99d;"></div>
              <span>Fertile Window</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #fde68a;"></div>
              <span>Ovulation</span>
            </div>
          </div>
          <div class="cycle-forecast" id="cycleForecast"></div>
          <div class="cycle-chart" id="cycleChartContainer">
            <canvas id="cycleChart" aria-label="Cycle probability chart" role="img"></canvas>
          </div>
        </div>
        <p style="color: var(--gray-500); font-size: 0.875rem; margin-top: var(--space-4); text-align: center;">
          <em>Note: This is an estimation tool for educational purposes only. Consult healthcare professionals for medical advice.</em>
        </p>
        <p style="color: var(--gray-600); font-size: 0.875rem; margin-top: var(--space-2); text-align: center;">
          <em>💡 Tip: Click to select date • Double-click to add/edit notes • 📝 shows days with notes</em>
        </p>
      </article>
    </div>
  </main>

  <!-- Toast Notification -->
  <div class="toast" id="toast">Changes saved successfully!</div>

  <!-- Motivation Modal -->
  <div class="motivation-modal" id="motivationModal">
    <div class="motivation-content">
      <div class="motivation-header">
        <h3 id="motivationTitle">Daily Motivation</h3>
        <button class="motivation-close" id="motivationClose" aria-label="Close motivation">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="motivation-body">
        <div id="motivationMessage" class="motivation-message">Click "Get Motivated" to see your personalized motivation!</div>
        <div class="motivation-actions">
          <button class="btn btn-secondary" id="nextMotivation">
            <i class="fas fa-refresh"></i> Next
          </button>
          <button class="btn btn-primary" id="saveMotivation">
            <i class="fas fa-heart"></i> Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Day Editor Modal -->
  <div class="day-editor-modal" id="dayEditorModal">
    <div class="day-editor-content">
      <div class="day-editor-header">
        <h3>Edit Day Note</h3>
        <button class="day-editor-close" id="dayEditorClose" aria-label="Close day editor">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="day-editor-body">
        <div class="day-editor-date" id="dayEditorDate">January 1, 2025</div>
        <textarea 
          class="day-editor-textarea" 
          id="dayEditorTextarea" 
          placeholder="Write a note for this day... (e.g., mood, events, reminders)"
        ></textarea>
        <div class="day-editor-actions">
          <button class="btn btn-secondary" id="dayEditorCancel">Cancel</button>
          <button class="btn btn-primary" id="dayEditorSave">Save Note</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Todo Schedule Modal -->
  <div class="schedule-modal" id="scheduleModal">
    <div class="schedule-content">
      <div class="schedule-header">
        <h3>Schedule Task</h3>
        <button class="schedule-close" id="scheduleClose" aria-label="Close schedule">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="schedule-body">
        <div class="schedule-row">
          <label for="scheduleDate">Date</label>
          <input type="date" id="scheduleDate" />
        </div>
        <div class="schedule-row">
          <label for="scheduleTime">Time</label>
          <input type="time" id="scheduleTime" />
        </div>
        <div class="schedule-row">
          <label for="scheduleText">Task</label>
          <input type="text" id="scheduleText" placeholder="Task title" />
        </div>
      </div>
      <div class="schedule-actions">
        <button class="btn btn-secondary" id="scheduleCancel">Cancel</button>
        <button class="btn btn-primary" id="scheduleSave">Add to day</button>
      </div>
    </div>
  </div>

  <script>
    // ========= Core Application Logic =========
    class DigitalPlanner {
      constructor() {
        this.currentDate = new Date();
        this.selectedDate = new Date();
        this.currentMonth = new Date();
        this.todos = [];
        this.waterCount = 0;
        this.waterTarget = 8;
        this.moodData = { emotion: '', rating: 5 };
        this.cycleData = { lastPeriod: null, cycleLength: 28, periodLength: 5 };
        this.currentMotivation = null;
        this.editingDate = null;
        this.motivation = {
          quoteIndex: 0,
          quotes: [
            { text: 'Start where you are. Use what you have. Do what you can.', author: 'Arthur Ashe' },
            { text: 'Success is the sum of small efforts, repeated day in and day out.', author: 'Robert Collier' },
            { text: 'What we do every day matters more than what we do once in a while.', author: 'Gretchen Rubin' },
            { text: 'Your future is created by what you do today, not tomorrow.', author: 'Robert Kiyosaki' },
            { text: 'Discipline is choosing what you want most over what you want now.', author: 'Craig Groeschel' },
            { text: 'The secret of getting ahead is getting started.', author: 'Mark Twain' },
            { text: 'Small progress is still progress.', author: 'Unknown' },
            { text: 'Dream big. Start small. Act now.', author: 'Robin Sharma' },
            { text: 'Focus on being productive instead of busy.', author: 'Tim Ferriss' },
            { text: 'Every action you take is a vote for the person you wish to become.', author: 'James Clear' }
          ],
          lastAffirmation: 'I choose focus, energy, and progress.',
          streakDays: 0,
          lastOpenDate: null,
          customAffirmations: [],
          affirmations: [
            'I am capable, focused, and resilient.',
            'I turn intention into action.',
            'I make steady progress every day.',
            'I am disciplined and consistent.',
            'I prioritize what truly matters.',
            'I have all I need to take the next step.',
            'I replace doubt with determination.',
            'I bring energy and clarity to my day.',
            'I finish what I start.',
            'I build good habits that build my future.'
          ]
        };
        
        this.init();
      }

      init() {
        this.setupEventListeners();
        this.setupDateInput();
        this.buildWaterTracker();
        this.buildMoodTracker();
        this.buildCalendar();
        this.loadData();
        this.startAutosave();
        this.renderCycleForecast();
        this.renderCycleChart();
      }

      setupEventListeners() {
        // Navigation
        document.getElementById('navToggle').addEventListener('click', this.toggleMenu.bind(this));
        document.addEventListener('click', this.closeMenuOutside.bind(this));

        // Menu actions
        document.getElementById('exportPDF').addEventListener('click', this.exportPDF.bind(this));
        document.getElementById('exportPNG').addEventListener('click', this.exportPNG.bind(this));
        document.getElementById('printPlanner').addEventListener('click', () => window.print());
        document.getElementById('savePlanner').addEventListener('click', this.saveData.bind(this));
        document.getElementById('resetPlanner').addEventListener('click', this.resetData.bind(this));
        document.getElementById('analytics').addEventListener('click', this.showAnalytics.bind(this));
        const exportAll = document.getElementById('exportAll');
        if (exportAll) exportAll.addEventListener('click', this.exportFullHistory.bind(this));
        const resetAll = document.getElementById('resetAll');
        if (resetAll) resetAll.addEventListener('click', this.resetAllData.bind(this));

        // Date input
        document.getElementById('plannerDate').addEventListener('change', this.onDateChange.bind(this));

        // Todos
        document.getElementById('addTodo').addEventListener('click', this.addTodo.bind(this));

        // Water tracker
        document.getElementById('waterIncrease').addEventListener('click', () => this.updateWaterCount(1));
        document.getElementById('waterDecrease').addEventListener('click', () => this.updateWaterCount(-1));
        document.getElementById('waterTarget').addEventListener('change', this.updateWaterTarget.bind(this));

        // Mood tracker
        document.getElementById('moodSlider').addEventListener('input', this.updateMoodRating.bind(this));

        // Notes formatting
        document.querySelectorAll('[data-format]').forEach(btn => {
          btn.addEventListener('click', (e) => this.formatText(e.currentTarget.dataset.format));
        });
        document.getElementById('exportNotes').addEventListener('click', this.exportNotes.bind(this));
        document.getElementById('notes').addEventListener('input', this.updateNotesStats.bind(this));

        // Calendar
        document.getElementById('prevMonth').addEventListener('click', () => this.navigateMonth(-1));
        document.getElementById('nextMonth').addEventListener('click', () => this.navigateMonth(1));
        document.getElementById('updateCycle').addEventListener('click', this.updateCycleData.bind(this));

        // Motivation
        const genAff = document.getElementById('generateAffirmation');
        if (genAff) genAff.addEventListener('click', this.generateAffirmation.bind(this));
        const nextQ = document.getElementById('nextQuote');
        if (nextQ) nextQ.addEventListener('click', this.nextQuote.bind(this));
        const celebrate = document.getElementById('motivationCelebrate');
        if (celebrate) celebrate.addEventListener('click', this.celebrate.bind(this));
        const addAff = document.getElementById('addAffirmation');
        if (addAff) addAff.addEventListener('click', this.addCustomAffirmation.bind(this));
        const shuffleAff = document.getElementById('shuffleAffirmations');
        if (shuffleAff) shuffleAff.addEventListener('click', this.shuffleAffirmations.bind(this));
        const copyAff = document.getElementById('copyAffirmation');
        if (copyAff) copyAff.addEventListener('click', this.copyAffirmation.bind(this));
        
        // Motivation Modal
        const showMotivation = document.getElementById('showMotivation');
        if (showMotivation) showMotivation.addEventListener('click', this.showMotivationModal.bind(this));
        const motivationClose = document.getElementById('motivationClose');
        if (motivationClose) motivationClose.addEventListener('click', this.hideMotivationModal.bind(this));
        const nextMotivation = document.getElementById('nextMotivation');
        if (nextMotivation) nextMotivation.addEventListener('click', this.nextMotivation.bind(this));
        const saveMotivation = document.getElementById('saveMotivation');
        if (saveMotivation) saveMotivation.addEventListener('click', this.saveMotivation.bind(this));
        
        // Close modal on outside click and ESC key
        document.addEventListener('click', (e) => {
          if (e.target.id === 'motivationModal') {
            this.hideMotivationModal();
          }
          if (e.target.id === 'dayEditorModal') {
            this.hideDayEditor();
          }
          if (e.target.id === 'scheduleModal') {
            this.closeScheduleModal();
          }
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.hideMotivationModal();
            this.hideDayEditor();
            this.closeScheduleModal();
          }
        });

        // Day Editor Modal
        const dayEditorClose = document.getElementById('dayEditorClose');
        if (dayEditorClose) dayEditorClose.addEventListener('click', this.hideDayEditor.bind(this));
        const dayEditorCancel = document.getElementById('dayEditorCancel');
        if (dayEditorCancel) dayEditorCancel.addEventListener('click', this.hideDayEditor.bind(this));
        const dayEditorSave = document.getElementById('dayEditorSave');
        if (dayEditorSave) dayEditorSave.addEventListener('click', this.saveDayNote.bind(this));

        // Auto-save on input changes
        document.querySelectorAll('[data-key]').forEach(input => {
          input.addEventListener('input', this.debounce(this.saveData.bind(this), 500));
        });

        // Schedule Modal
        const scheduleClose = document.getElementById('scheduleClose');
        if (scheduleClose) scheduleClose.addEventListener('click', this.closeScheduleModal.bind(this));
        const scheduleCancel = document.getElementById('scheduleCancel');
        if (scheduleCancel) scheduleCancel.addEventListener('click', this.closeScheduleModal.bind(this));
        const scheduleSave = document.getElementById('scheduleSave');
        if (scheduleSave) scheduleSave.addEventListener('click', this.saveScheduledTask.bind(this));
      }

      setupDateInput() {
        const dateInput = document.getElementById('plannerDate');
        dateInput.valueAsDate = this.selectedDate;
        this.updateDateDisplay();
      }

      onDateChange() {
        const dateInput = document.getElementById('plannerDate');
        this.selectedDate = new Date(dateInput.value);
        this.updateDateDisplay();
        this.loadData();
      }

      updateDateDisplay() {
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        document.getElementById('dateDisplay').textContent = 
          this.selectedDate.toLocaleDateString('en-US', options);
      }

      // ========= Todo Management =========
      addTodo(text = '', completed = false) {
        const todoList = document.getElementById('todoList');
        const li = document.createElement('li');
        li.className = 'todo-item fade-in';
        
        const todoId = Date.now() + Math.random();
        li.innerHTML = `
          <input type="checkbox" class="todo-checkbox" ${completed ? 'checked' : ''} data-id="${todoId}">
          <input type="text" class="todo-input ${completed ? 'completed' : ''}" 
                 value="${this.escapeHtml(text)}" placeholder="Add a new task..." data-id="${todoId}">
          <div class="todo-actions">
            <button class="icon-btn" title="Duplicate" data-action="duplicate" data-id="${todoId}">
              <i class="fas fa-copy"></i>
            </button>
            <button class="icon-btn" title="Delete" data-action="delete" data-id="${todoId}">
              <i class="fas fa-trash"></i>
            </button>
            <button class="icon-btn" title="Schedule to calendar" data-action="schedule" data-id="${todoId}">
              <i class="fas fa-calendar-plus"></i>
            </button>
          </div>
        `;

        todoList.appendChild(li);
        this.attachTodoListeners(li, todoId);
        this.updateTodoProgress();
        
        // Focus on the input
        li.querySelector('.todo-input').focus();
      }

      attachTodoListeners(li, todoId) {
        const checkbox = li.querySelector('.todo-checkbox');
        const input = li.querySelector('.todo-input');
        const actions = li.querySelectorAll('[data-action]');

        checkbox.addEventListener('change', () => {
          input.classList.toggle('completed', checkbox.checked);
          this.updateTodoProgress();
          this.saveData();
        });

        input.addEventListener('input', this.debounce(this.saveData.bind(this), 300));

        actions.forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.target.closest('[data-action]').dataset.action;
            if (action === 'delete') {
              li.remove();
              this.updateTodoProgress();
              this.saveData();
            } else if (action === 'duplicate') {
              this.addTodo(input.value, checkbox.checked);
            } else if (action === 'schedule') {
              this.openScheduleModal({ id: todoId, text: input.value });
            }
          });
        });
      }

      updateTodoProgress() {
        const todos = document.querySelectorAll('.todo-item');
        const completed = document.querySelectorAll('.todo-checkbox:checked').length;
        const total = todos.length;
        document.getElementById('todoProgress').textContent = `${completed}/${total}`;
        this.updateMotivationProgress();
        this.updateStreak();
      }

      getTodos() {
        return Array.from(document.querySelectorAll('.todo-item')).map(item => {
          const checkbox = item.querySelector('.todo-checkbox');
          const input = item.querySelector('.todo-input');
          return {
            text: input.value.trim(),
            completed: checkbox.checked
          };
        }).filter(todo => todo.text !== '');
      }

      setTodos(todos) {
        const todoList = document.getElementById('todoList');
        todoList.innerHTML = '';
        
        if (!todos || !todos.length) {
          this.addTodo('', false);
          return;
        }

        todos.forEach(todo => {
          this.addTodo(todo.text, todo.completed);
        });
      }

      // ========= Water Tracker =========
      buildWaterTracker() {
        this.renderWaterGlasses();
        this.updateWaterDisplay();
      }

      renderWaterGlasses() {
        const grid = document.getElementById('waterGrid');
        grid.innerHTML = '';
        
        for (let i = 0; i < this.waterTarget; i++) {
          const glass = document.createElement('div');
          glass.className = 'water-glass';
          glass.innerHTML = '<div class="water-fill"></div>';
          glass.addEventListener('click', () => this.setWaterCount(i + 1));
          grid.appendChild(glass);
        }
        
        this.updateWaterDisplay();
      }

      updateWaterCount(change) {
        this.waterCount = Math.max(0, Math.min(this.waterTarget, this.waterCount + change));
        this.updateWaterDisplay();
        this.saveData();
      }

      setWaterCount(count) {
        this.waterCount = Math.max(0, Math.min(this.waterTarget, count));
        this.updateWaterDisplay();
        this.saveData();
      }

      updateWaterTarget() {
        const target = parseInt(document.getElementById('waterTarget').value);
        this.waterTarget = Math.max(1, Math.min(20, target));
        this.waterCount = Math.min(this.waterCount, this.waterTarget);
        this.renderWaterGlasses();
        this.saveData();
      }

      updateWaterDisplay() {
        const glasses = document.querySelectorAll('.water-glass');
        glasses.forEach((glass, index) => {
          glass.classList.toggle('filled', index < this.waterCount);
        });

        const percentage = (this.waterCount / this.waterTarget) * 100;
        document.getElementById('waterProgressBar').style.width = `${percentage}%`;
        document.getElementById('waterCurrent').textContent = this.waterCount;
        document.getElementById('waterProgress').textContent = `${this.waterCount}/${this.waterTarget} glasses`;
        document.getElementById('waterStats').textContent = 
          `${this.waterCount} of ${this.waterTarget} glasses completed`;
        this.updateMotivationProgress();
      }

      // ========= Mood Tracker =========
      buildMoodTracker() {
        const emotions = [
          { emoji: '😊', name: 'Happy', value: 'happy' },
          { emoji: '😌', name: 'Calm', value: 'calm' },
          { emoji: '😢', name: 'Sad', value: 'sad' },
          { emoji: '😴', name: 'Tired', value: 'tired' },
          { emoji: '😤', name: 'Frustrated', value: 'frustrated' },
          { emoji: '🤗', name: 'Loved', value: 'loved' },
          { emoji: '😎', name: 'Confident', value: 'confident' },
          { emoji: '😰', name: 'Anxious', value: 'anxious' }
        ];

        const container = document.getElementById('moodEmotions');
        container.innerHTML = '';

        emotions.forEach(emotion => {
          const btn = document.createElement('button');
          btn.className = 'mood-emotion';
          btn.innerHTML = emotion.emoji;
          btn.title = emotion.name;
          btn.dataset.emotion = emotion.value;
          btn.addEventListener('click', () => this.selectMoodEmotion(emotion.value));
          container.appendChild(btn);
        });

        this.updateMoodDisplay();
      }

      selectMoodEmotion(emotion) {
        document.querySelectorAll('.mood-emotion').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.emotion === emotion);
        });
        this.moodData.emotion = emotion;
        this.saveData();
        this.updateMotivationProgress();
        const negative = ['sad','tired','frustrated','anxious'];
        if (negative.includes(this.moodData.emotion) && (this.moodData.rating || 0) >= 7) {
          this.showSupportiveQuote();
        }
      }

      updateMoodRating() {
        const slider = document.getElementById('moodSlider');
        this.moodData.rating = parseInt(slider.value);
        document.getElementById('moodValue').textContent = `${this.moodData.rating}/10`;
        this.saveData();
        this.updateMotivationProgress();
        const negative = ['sad','tired','frustrated','anxious'];
        if (negative.includes(this.moodData.emotion) && this.moodData.rating >= 7) {
          this.showSupportiveQuote();
        }
      }

      updateMoodDisplay() {
        document.getElementById('moodSlider').value = this.moodData.rating;
        document.getElementById('moodValue').textContent = `${this.moodData.rating}/10`;
        
        if (this.moodData.emotion) {
          document.querySelectorAll('.mood-emotion').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.emotion === this.moodData.emotion);
          });
        }
      }

      // ========= Calendar & Cycle Tracking =========
      buildCalendar() {
        const year = this.currentMonth.getFullYear();
        const month = this.currentMonth.getMonth();
        
        document.getElementById('calendarTitle').textContent = 
          this.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        // Day headers
        const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        dayHeaders.forEach(day => {
          const header = document.createElement('div');
          header.className = 'calendar-day-header';
          header.textContent = day;
          grid.appendChild(header);
        });

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDay = (firstDay.getDay() + 6) % 7; // Make Monday = 0

        // Add empty cells for days before month starts
        for (let i = 0; i < startDay; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day other-month';
          grid.appendChild(emptyDay);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';
          dayElement.textContent = day;
          
          const currentDate = new Date(year, month, day);
          
          // Check if it's today
          if (this.isSameDate(currentDate, new Date())) {
            dayElement.classList.add('today');
          }
          
          // Check if it's selected date
          if (this.isSameDate(currentDate, this.selectedDate)) {
            dayElement.classList.add('selected');
          }

          // Add cycle tracking classes
          this.addCycleClasses(dayElement, currentDate);

          // Probability classes
          const prob = this.getCycleProbabilityForDate(currentDate);
          if (prob.prob === 'high') dayElement.classList.add('prob-high');
          else if (prob.prob === 'medium') dayElement.classList.add('prob-medium');
          else if (prob.prob === 'low') dayElement.classList.add('prob-low');

          // Add day note indicator
          this.updateDayNoteIndicator(dayElement, currentDate);

          // Add click listener
          dayElement.addEventListener('click', () => {
            this.selectedDate = new Date(currentDate);
            document.getElementById('plannerDate').valueAsDate = this.selectedDate;
            this.updateDateDisplay();
            this.buildCalendar();
            this.loadData();
            this.renderCycleForecast();
            this.renderCycleChart();
          });

          // Add double-click listener for editing notes
          dayElement.addEventListener('dblclick', () => {
            this.editDayNote(currentDate);
          });

          grid.appendChild(dayElement);
        }
      }

      addCycleClasses(dayElement, date) {
        if (!this.cycleData.lastPeriod) return;

        const lastPeriod = new Date(this.cycleData.lastPeriod);
        const daysDiff = Math.floor((date - lastPeriod) / (1000 * 60 * 60 * 24));
        const cycleDay = ((daysDiff % this.cycleData.cycleLength) + this.cycleData.cycleLength) % this.cycleData.cycleLength;

        // Period days
        if (cycleDay < this.cycleData.periodLength) {
          dayElement.classList.add('period');
        }
        
        // Fertile window (typically 5 days before ovulation + ovulation day)
        const ovulationDay = this.cycleData.cycleLength - 14;
        if (cycleDay >= ovulationDay - 5 && cycleDay <= ovulationDay + 1) {
          dayElement.classList.add('fertile');
        }
        
        // Ovulation day
        if (cycleDay === ovulationDay) {
          dayElement.classList.add('ovulation');
        }
      }

      navigateMonth(direction) {
        this.currentMonth.setMonth(this.currentMonth.getMonth() + direction);
        this.buildCalendar();
        this.renderCycleForecast();
        this.renderCycleChart();
      }

      updateCycleData() {
        const lastPeriod = document.getElementById('lastPeriod').value;
        const cycleLength = parseInt(document.getElementById('cycleLength').value);
        const periodLength = parseInt(document.getElementById('periodLength').value);

        this.cycleData = {
          lastPeriod: lastPeriod ? new Date(lastPeriod) : null,
          cycleLength: Math.max(20, Math.min(40, cycleLength || 28)),
          periodLength: Math.max(1, Math.min(10, periodLength || 5))
        };

        this.buildCalendar();
        this.saveData();
        this.showToast('Cycle data updated successfully!');
        this.renderCycleForecast();
        this.renderCycleChart();
      }

      // ========= Notes & Formatting =========
      formatText(format) {
        const textarea = document.getElementById('notes');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        let newText;
        if (format === '**') {
          newText = `**${selectedText}**`;
        } else {
          newText = format + selectedText;
        }
        
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        textarea.focus();
        textarea.setSelectionRange(start + format.length, start + format.length + selectedText.length);
        
        this.updateNotesStats();
        this.saveData();
      }

      updateNotesStats() {
        const notes = document.getElementById('notes').value;
        const wordCount = notes.trim() ? notes.trim().split(/\s+/).length : 0;
        const charCount = notes.length;
        
        document.getElementById('wordCount').textContent = `${wordCount} words`;
        document.getElementById('charCount').textContent = `${charCount} characters`;
      }

      exportNotes() {
        const notes = document.getElementById('notes').value;
        const blob = new Blob([notes], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `planner-notes-${this.formatDate(this.selectedDate)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        this.showToast('Notes exported successfully!');
      }

      // ========= Data Management =========
      getStorageKey() {
        return `digitalPlanner_${this.formatDate(this.selectedDate)}`;
      }

      collectData() {
        return {
          date: this.formatDate(this.selectedDate),
          todos: this.getTodos(),
          priority1: document.getElementById('priority1').value,
          priority2: document.getElementById('priority2').value,
          priority3: document.getElementById('priority3').value,
          morning: document.getElementById('morning').value,
          afternoon: document.getElementById('afternoon').value,
          evening: document.getElementById('evening').value,
          breakfast: document.getElementById('breakfast').value,
          lunch: document.getElementById('lunch').value,
          dinner: document.getElementById('dinner').value,
          snacks: document.getElementById('snacks').value,
          waterCount: this.waterCount,
          waterTarget: this.waterTarget,
          moodData: this.moodData,
          moodNotes: document.getElementById('moodNotes').value,
          gratitude1: document.getElementById('gratitude1').value,
          gratitude2: document.getElementById('gratitude2').value,
          gratitude3: document.getElementById('gratitude3').value,
          notes: document.getElementById('notes').value,
          cycleData: this.cycleData,
          motivation: {
            quoteIndex: this.motivation.quoteIndex,
            lastAffirmation: this.motivation.lastAffirmation,
            streakDays: this.motivation.streakDays,
            lastOpenDate: this.motivation.lastOpenDate,
            customAffirmations: this.motivation.customAffirmations
          }
        };
      }

      saveData() {
        const data = this.collectData();
        localStorage.setItem(this.getStorageKey(), JSON.stringify(data));
        localStorage.setItem('digitalPlanner_global', JSON.stringify({
          cycleData: this.cycleData,
          waterTarget: this.waterTarget
        }));
        this.showToast('Data saved successfully!');
      }

      loadData() {
        // Load global data first
        const globalData = JSON.parse(localStorage.getItem('digitalPlanner_global') || '{}');
        if (globalData.cycleData) {
          this.cycleData = globalData.cycleData;
          if (this.cycleData.lastPeriod) {
            document.getElementById('lastPeriod').value = this.formatDate(new Date(this.cycleData.lastPeriod));
          }
          document.getElementById('cycleLength').value = this.cycleData.cycleLength;
          document.getElementById('periodLength').value = this.cycleData.periodLength;
        }
        
        if (globalData.waterTarget) {
          this.waterTarget = globalData.waterTarget;
          document.getElementById('waterTarget').value = this.waterTarget;
          this.renderWaterGlasses();
        }

        // Load day-specific data
        const data = JSON.parse(localStorage.getItem(this.getStorageKey()) || '{}');
        
        // Restore todos
        this.setTodos(data.todos);
        
        // Restore form fields
        const fields = [
          'priority1', 'priority2', 'priority3',
          'morning', 'afternoon', 'evening',
          'breakfast', 'lunch', 'dinner', 'snacks',
          'moodNotes', 'gratitude1', 'gratitude2', 'gratitude3', 'notes'
        ];
        
        fields.forEach(field => {
          const element = document.getElementById(field);
          if (element && data[field]) {
            element.value = data[field];
          }
        });
        
        // Restore water count
        if (data.waterCount !== undefined) {
          this.waterCount = data.waterCount;
          this.updateWaterDisplay();
        }
        
        // Restore mood data
        if (data.moodData) {
          this.moodData = data.moodData;
          this.updateMoodDisplay();
        }

        // Motivation
        if (data.motivation) {
          this.motivation.quoteIndex = data.motivation.quoteIndex || 0;
          this.motivation.lastAffirmation = data.motivation.lastAffirmation || this.motivation.lastAffirmation;
          this.motivation.streakDays = data.motivation.streakDays || 0;
          this.motivation.lastOpenDate = data.motivation.lastOpenDate || null;
          this.motivation.customAffirmations = data.motivation.customAffirmations || [];
        }
        this.updateStreak();
        this.renderCurrentQuote();
        this.renderAffirmation();
        this.renderCustomAffirmations();
        this.updateMotivationProgress();

        this.updateNotesStats();
        this.buildCalendar();
        this.renderCycleForecast();
      }

      resetData() {
        if (confirm('Are you sure you want to reset all data for this day? This action cannot be undone.')) {
          localStorage.removeItem(this.getStorageKey());
          
          // Reset form fields
          document.querySelectorAll('input[type="text"], textarea').forEach(field => {
            field.value = '';
          });
          
          // Reset todos
          this.setTodos([]);
          
          // Reset water
          this.waterCount = 0;
          this.updateWaterDisplay();
          
          // Reset mood
          this.moodData = { emotion: '', rating: 5 };
          this.updateMoodDisplay();
          
          this.updateNotesStats();
          this.showToast('Data reset successfully!');
        }
      }

      resetAllData() {
        if (!confirm('This will erase ALL planner data across all days. Continue?')) return;
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('digitalPlanner_')) keys.push(key);
        }
        keys.forEach(k => localStorage.removeItem(k));
        localStorage.removeItem('digitalPlanner_global');
        localStorage.removeItem('digitalPlanner_motivation');
        this.todos = [];
        this.waterCount = 0;
        this.waterTarget = 8;
        this.moodData = { emotion: '', rating: 5 };
        this.cycleData = { lastPeriod: null, cycleLength: 28, periodLength: 5 };
        this.setTodos([]);
        this.renderWaterGlasses();
        this.updateWaterDisplay();
        this.updateMoodDisplay();
        this.buildCalendar();
        this.renderCycleForecast();
        this.showToast('All data has been reset.');
      }

      startAutosave() {
        setInterval(() => {
          this.saveData();
        }, 60000); // Auto-save every minute
      }

      // ========= Export Functions =========
      async exportPDF() {
        try {
          const { jsPDF } = window.jspdf;
          const content = document.getElementById('plannerContent');
          
          this.showToast('Generating PDF...');
          
          const canvas = await html2canvas(content, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
          });
          
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          const pdf = new jsPDF({
            unit: 'pt',
            format: 'a4',
            orientation: 'portrait'
          });
          
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgWidth = pageWidth - 40;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          if (imgHeight <= pageHeight - 40) {
            pdf.addImage(imgData, 'JPEG', 20, 20, imgWidth, imgHeight);
          } else {
            // Handle multi-page PDF
            let position = 0;
            const pageHeightUsable = pageHeight - 40;
            
            while (position < imgHeight) {
              pdf.addImage(imgData, 'JPEG', 20, 20 - position, imgWidth, imgHeight);
              position += pageHeightUsable;
              
              if (position < imgHeight) {
                pdf.addPage();
              }
            }
          }
          
          pdf.save(`digital-planner-${this.formatDate(this.selectedDate)}.pdf`);
          this.showToast('PDF exported successfully!');
        } catch (error) {
          console.error('PDF export failed:', error);
          this.showToast('PDF export failed. Please try again.');
        }
      }

      async exportPNG() {
        try {
          const content = document.getElementById('plannerContent');
          
          this.showToast('Generating image...');
          
          const canvas = await html2canvas(content, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
          });
          
          const link = document.createElement('a');
          link.download = `digital-planner-${this.formatDate(this.selectedDate)}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          
          this.showToast('Image exported successfully!');
        } catch (error) {
          console.error('Image export failed:', error);
          this.showToast('Image export failed. Please try again.');
        }
      }

      // ========= Analytics =========
      showAnalytics() {
        const allData = this.getAllStoredData();
        const analytics = this.calculateAnalytics(allData);
        
        alert(`📊 Your Productivity Analytics\n\n` +
              `📅 Days tracked: ${analytics.daysTracked}\n` +
              `✅ Total tasks completed: ${analytics.totalTasksCompleted}\n` +
              `💧 Average water intake: ${analytics.avgWater} glasses\n` +
              `😊 Average mood rating: ${analytics.avgMood}/10\n` +
              `📝 Total notes written: ${analytics.totalWords} words\n\n` +
              `Keep up the great work!`);
      }

      exportFullHistory() {
        const all = this.getAllStoredData();
        const global = JSON.parse(localStorage.getItem('digitalPlanner_global') || '{}');
        let out = `Digital Planner History Export\nGenerated: ${new Date().toISOString()}\n\n`;
        out += `Global Settings: waterTarget=${global.waterTarget || 8}, cycleLength=${global.cycleData?.cycleLength || 28}, periodLength=${global.cycleData?.periodLength || 5}\n\n`;
        all.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
        all.forEach(day => {
          out += `Date: ${day.date}\n`;
          out += `  Todos Completed: ${(day.todos||[]).filter(t=>t.completed).length}/${(day.todos||[]).length}\n`;
          out += `  Water: ${day.waterCount || 0}/${day.waterTarget || global.waterTarget || 8}\n`;
          out += `  Mood: ${(day.moodData?.emotion)||''} ${(day.moodData?.rating)||''}/10\n`;
          out += `  Cycle: lastPeriod=${(day.cycleData?.lastPeriod)? new Date(day.cycleData.lastPeriod).toISOString().split('T')[0]:''}, cycleLength=${day.cycleData?.cycleLength||global.cycleData?.cycleLength||28}\n`;
          out += `  Gratitude: ${(day.gratitude1||'')}; ${(day.gratitude2||'')}; ${(day.gratitude3||'')}\n`;
          if (day.notes) out += `  Notes: ${day.notes.replace(/\n/g,' ')}\n`;
          out += `\n`;
        });
        const blob = new Blob([out], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'digital-planner-history.txt';
        a.click();
        URL.revokeObjectURL(url);
        this.showToast('Full history exported');
      }

      getAllStoredData() {
        const data = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('digitalPlanner_') && key !== 'digitalPlanner_global') {
            try {
              const dayData = JSON.parse(localStorage.getItem(key));
              data.push(dayData);
            } catch (e) {
              console.warn('Failed to parse data for key:', key);
            }
          }
        }
        return data;
      }

      calculateAnalytics(data) {
        const analytics = {
          daysTracked: data.length,
          totalTasksCompleted: 0,
          avgWater: 0,
          avgMood: 0,
          totalWords: 0
        };

        if (data.length === 0) return analytics;

        let totalWater = 0;
        let totalMood = 0;
        let moodCount = 0;

        data.forEach(day => {
          if (day.todos) {
            analytics.totalTasksCompleted += day.todos.filter(todo => todo.completed).length;
          }
          
          if (day.waterCount) {
            totalWater += day.waterCount;
          }
          
          if (day.moodData && day.moodData.rating) {
            totalMood += day.moodData.rating;
            moodCount++;
          }
          
          if (day.notes) {
            analytics.totalWords += day.notes.trim().split(/\s+/).length;
          }
        });

        analytics.avgWater = Math.round((totalWater / data.length) * 10) / 10;
        analytics.avgMood = moodCount > 0 ? Math.round((totalMood / moodCount) * 10) / 10 : 0;

        return analytics;
      }

      // ========= Utility Functions =========
      getCycleDay(date) {
        if (!this.cycleData.lastPeriod || !this.cycleData.cycleLength) return null;
        const last = new Date(this.cycleData.lastPeriod);
        const L = Math.max(20, Math.min(40, parseInt(this.cycleData.cycleLength) || 28));
        const diffDays = Math.floor((date - last) / (1000 * 60 * 60 * 24));
        const cycleDay = ((diffDays % L) + L) % L; // wrap into [0, L)
        return cycleDay;
      }

      getCyclePhase(date) {
        const L = Math.max(20, Math.min(40, parseInt(this.cycleData.cycleLength) || 28));
        const day = this.getCycleDay(date);
        if (day === null) return { name: 'Unknown', desc: 'Add your last period to see phase.', code: 'unknown' };
        if (day < (this.cycleData.periodLength || 5)) return { name: 'Menstrual', desc: 'Rest and recovery time', code: 'menstrual' };
        if (day <= L - 14 - 1) return { name: 'Follicular', desc: 'Building energy and creativity', code: 'follicular' };
        if (day === L - 14) return { name: 'Ovulation', desc: 'Peak fertility and vitality', code: 'ovulation' };
        return { name: 'Luteal', desc: 'Preparing for next cycle', code: 'luteal' };
      }

      // Probability and classification for calendar coloring and charts
      getCycleProbabilityForDate(date) {
        if (!this.cycleData.lastPeriod || !this.cycleData.cycleLength) return { prob: 'low', score: 0 };
        const L = Math.max(20, Math.min(40, parseInt(this.cycleData.cycleLength) || 28));
        const ov = L - 14; // typical luteal length
        const day = this.getCycleDay(date);
        if (day === null) return { prob: 'low', score: 0 };

        // Triangular-like fertility score peaking at ovulation, width ~ ±6 days
        const width = 6;
        const dist = Math.abs(day - ov);
        const score = Math.max(0, 1 - (dist / width)); // 1 at ovulation, ~0 at ±6

        let prob = 'low';
        if (dist <= 2) prob = 'high';
        else if (dist <= 5) prob = 'medium';

        return { prob, score: Math.max(0, Math.min(1, score)) };
      }

      ensureChartLibraryLoaded() {
        if (typeof Chart !== 'undefined') return Promise.resolve();
        return new Promise((resolve) => {
          const existing = document.querySelector('script[src*="chart.umd.js"]');
          if (existing) { existing.addEventListener('load', () => resolve()); return; }
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
          script.onload = () => resolve();
          script.onerror = () => resolve();
          document.head.appendChild(script);
        });
      }

      renderCycleForecast() {
        const el = document.getElementById('cycleForecast');
        if (!el) return;
        if (!this.cycleData.lastPeriod) { el.textContent = 'Add your last period to see forecast.'; return; }
        const L = this.cycleData.cycleLength || 28;
        const ovulationDay = L - 14;
        const start = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
        const end = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth()+1, 0);
        // Find next ovulation date after today
        const today = new Date();
        let nextOvulation = null;
        for (let i = 0; i < 120; i++) { // look ahead ~4 months
          const d = new Date(today);
          d.setDate(today.getDate()+i);
          const p = this.getCycleProbabilityForDate(d);
          if (p.prob === 'high') { nextOvulation = d; break; }
        }
        const fertileWindow = [];
        for (let i = -5; i <= 1; i++) {
          const d = new Date((nextOvulation||today));
          d.setDate((nextOvulation||today).getDate()+i);
          fertileWindow.push(this.formatDate(d));
        }
        const phase = this.getCyclePhase(today);
        el.innerHTML = `Next ovulation approx: <strong>${nextOvulation? this.formatDate(nextOvulation): 'N/A'}</strong><br/>`
          + `Fertile window: <strong>${fertileWindow[0]}</strong> → <strong>${fertileWindow[fertileWindow.length-1]}</strong><br/>`
          + `<span style=\"color:#16a34a\">High</span> ≈ ovulation±2, <span style=\"color:#f59e0b\">Medium</span> ≈ ovulation±5, <span style=\"color:#9ca3af\">Low</span> otherwise.<br/>`
          + `Current phase: <strong>${phase.name}</strong> — ${phase.desc}`;
      }

      renderCycleChart() {
        const canvas = document.getElementById('cycleChart');
        const container = document.getElementById('cycleChartContainer');
        if (!canvas || !container) return;
        if (!this.cycleData.lastPeriod || !this.cycleData.cycleLength) {
          container.style.display = 'none';
          return;
        }
        container.style.display = '';
        // Ensure Chart library is loaded
        if (typeof Chart === 'undefined') { this.ensureChartLibraryLoaded().then(() => this.renderCycleChart()); return; }
        const ctx = canvas.getContext('2d');

        // Build time series for current month
        const start = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
        const end = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth()+1, 0);
        const labels = [];
        const data = [];
        const pointsBg = [];
        const pointsBo = [];
        const ovDay = Math.max(20, Math.min(40, parseInt(this.cycleData.cycleLength) || 28)) - 14;
        const today = new Date();
        for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
          const label = `${d.getMonth()+1}/${d.getDate()}`;
          labels.push(label);
          const p = this.getCycleProbabilityForDate(d);
          data.push(Math.round(p.score * 100) / 100);
          const day = this.getCycleDay(d);
          const isOv = (day === ovDay);
          const isToday = this.isSameDate(d, today);
          const color = isOv ? '#f59e0b' : p.prob === 'high' ? '#16a34a' : p.prob === 'medium' ? '#f59e0b' : '#9ca3af';
          pointsBg.push(isToday ? '#6366f1' : color);
          pointsBo.push(isToday ? '#4f46e5' : color);
        }

        // Destroy previous chart instance if exists
        if (this._cycleChart && typeof this._cycleChart.destroy === 'function') {
          this._cycleChart.destroy();
        }

        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(22, 163, 74, 0.25)');
        gradient.addColorStop(1, 'rgba(22, 163, 74, 0.02)');

        this._cycleChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Fertility probability',
              data,
              fill: true,
              backgroundColor: gradient,
              borderColor: '#16a34a',
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: pointsBg,
              pointBorderColor: pointsBo,
              tension: 0.25
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
              y: { beginAtZero: true, max: 1, ticks: { callback: (v) => `${Math.round(v*100)}%` } },
              x: { grid: { display: false } }
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (ctx) => `Probability: ${Math.round((ctx.parsed.y||0)*100)}%` } }
            }
          }
        });
      }
      // Motivation utilities
      updateMotivationProgress() {
        try {
          const percent = Math.round(100 * (
            this.getTodoCompletionRatio() * 0.5 +
            this.getWaterRatio() * 0.25 +
            this.getMoodRatio() * 0.25
          ));
          const label = document.getElementById('motivationProgressLabel');
          if (label) label.textContent = `${percent}%`;
          this.updateProgressRing(percent);
          const badge = document.getElementById('motivationBadge');
          if (badge) {
            badge.textContent = percent >= 90 ? 'On Fire' : percent >= 60 ? 'Great Momentum' : 'Daily Boost';
          }
        } catch (_) {}
      }

      getTodoCompletionRatio() {
        const total = document.querySelectorAll('.todo-item').length;
        if (total === 0) return 0;
        const completed = document.querySelectorAll('.todo-checkbox:checked').length;
        return completed / total;
      }

      getWaterRatio() {
        if (this.waterTarget <= 0) return 0;
        return Math.min(1, this.waterCount / this.waterTarget);
      }

      getMoodRatio() {
        return Math.min(1, Math.max(0, (this.moodData.rating || 0) / 10));
      }

      updateProgressRing(percent) {
        const circle = document.getElementById('progressRingCircle');
        if (!circle) return;
        const radius = 70;
        const circumference = 2 * Math.PI * radius;
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        const offset = circumference * (1 - percent / 100);
        circle.style.strokeDashoffset = `${offset}`;
        circle.style.stroke = percent >= 90 ? '#22c55e' : percent >= 60 ? '#6366f1' : '#a5b4fc';
      }

      renderCurrentQuote() {
        const q = this.motivation.quotes[this.motivation.quoteIndex % this.motivation.quotes.length];
        const qt = document.getElementById('quoteText');
        const qa = document.getElementById('quoteAuthor');
        if (qt && qa && q) {
          qt.classList.remove('slide-up');
          void qt.offsetWidth; // reflow for animation restart
          qt.textContent = q.text;
          qa.textContent = `— ${q.author}`;
          qt.classList.add('slide-up');
        }
      }

      nextQuote() {
        this.motivation.quoteIndex = (this.motivation.quoteIndex + 1) % this.motivation.quotes.length;
        this.renderCurrentQuote();
        this.saveData();
      }

      renderAffirmation() {
        const el = document.getElementById('affirmationText');
        if (el) el.textContent = this.motivation.lastAffirmation;
      }

      generateAffirmation() {
        const list = [...this.motivation.affirmations, ...(this.motivation.customAffirmations||[])];
        const pick = list[Math.floor(Math.random() * Math.max(1, list.length))] || 'I choose focus, energy, and progress.';
        this.motivation.lastAffirmation = pick;
        this.renderAffirmation();
        this.showToast('Affirmation updated!');
        this.saveData();
      }

      addCustomAffirmation() {
        const input = document.getElementById('affInput');
        if (!input) return;
        const text = (input.value||'').trim();
        if (!text) return;
        this.motivation.customAffirmations = this.motivation.customAffirmations || [];
        this.motivation.customAffirmations.unshift(text);
        input.value = '';
        this.renderCustomAffirmations();
        this.saveData();
        this.showToast('Affirmation added');
      }

      renderCustomAffirmations() {
        const listEl = document.getElementById('customAffList');
        if (!listEl) return;
        const items = this.motivation.customAffirmations || [];
        listEl.innerHTML = '';
        items.slice(0, 20).forEach((t, idx) => {
          const row = document.createElement('div');
          row.className = 'custom-aff-item';
          row.innerHTML = `<span>${this.escapeHtml(t)}</span>`;
          const right = document.createElement('div');
          right.style.display = 'flex';
          right.style.gap = '8px';
          const useBtn = document.createElement('button');
          useBtn.className = 'btn btn-secondary btn-sm';
          useBtn.textContent = 'Use';
          useBtn.addEventListener('click', () => { this.motivation.lastAffirmation = t; this.renderAffirmation(); this.saveData(); });
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-secondary btn-sm';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => { this.motivation.customAffirmations.splice(idx, 1); this.renderCustomAffirmations(); this.saveData(); });
          right.appendChild(useBtn);
          right.appendChild(delBtn);
          row.appendChild(right);
          listEl.appendChild(row);
        });
      }

      shuffleAffirmations() {
        const combined = [...this.motivation.affirmations, ...(this.motivation.customAffirmations||[])];
        for (let i = combined.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [combined[i], combined[j]] = [combined[j], combined[i]];
        }
        this.motivation.affirmations = combined.filter((t,i)=> i < 10); // keep base rotated
        this.showToast('Affirmations shuffled');
      }

      copyAffirmation() {
        const text = this.motivation.lastAffirmation || '';
        if (!navigator.clipboard) {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); } catch(e) {}
          ta.remove();
        } else {
          navigator.clipboard.writeText(text).catch(()=>{});
        }
        this.showToast('Affirmation copied');
      }

      updateStreak() {
        const todayStr = this.formatDate(new Date());
        const last = this.motivation.lastOpenDate;
        if (last !== todayStr) {
          if (last) {
            const diff = Math.floor((new Date(todayStr) - new Date(last)) / (1000*60*60*24));
            this.motivation.streakDays = diff === 1 ? (this.motivation.streakDays || 0) + 1 : 1;
          } else {
            this.motivation.streakDays = this.motivation.streakDays || 1;
          }
          this.motivation.lastOpenDate = todayStr;
          this.saveData();
        }
        const pill = document.getElementById('streakValue');
        if (pill) pill.textContent = this.motivation.streakDays || 0;
        // Wins today = completed todos
        const wins = document.querySelectorAll('.todo-checkbox:checked').length;
        const winsEl = document.getElementById('winsValue');
        if (winsEl) winsEl.textContent = wins;
      }

      celebrate() {
        const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#a78bfa'];
        const pieces = 80;
        for (let i = 0; i < pieces; i++) {
          const div = document.createElement('div');
          div.className = 'confetti';
          div.style.left = Math.random() * 100 + 'vw';
          div.style.background = colors[Math.floor(Math.random() * colors.length)];
          div.style.transform = `translateY(-10px) rotate(${Math.random() * 360}deg)`;
          div.style.animationDelay = Math.random() * 200 + 'ms';
          document.body.appendChild(div);
          setTimeout(() => div.remove(), 1500);
        }
      }
      toggleMenu() {
        const menu = document.getElementById('navMenu');
        menu.classList.toggle('active');
      }

      closeMenuOutside(e) {
        const menu = document.getElementById('navMenu');
        const toggle = document.getElementById('navToggle');
        
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
          menu.classList.remove('active');
        }
      }

      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      formatDate(date) {
        return date.toISOString().split('T')[0];
      }

      isSameDate(date1, date2) {
        return date1.getFullYear() === date2.getFullYear() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getDate() === date2.getDate();
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // ========= Motivation System =========
      showMotivationModal() {
        const modal = document.getElementById('motivationModal');
        if (!modal) {
          console.error('Motivation modal not found!');
          return;
        }
        
        console.log('Opening motivation modal...');
        this.currentMotivation = this.getCycleBasedMotivation();
        this.displayMotivation(this.currentMotivation);
        
        // Force modal to be visible
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        console.log('Modal should be visible now');
      }

      hideMotivationModal() {
        const modal = document.getElementById('motivationModal');
        if (!modal) return;
        
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }

      getCycleBasedMotivation() {
        if (!this.cycleData.lastPeriod || !this.cycleData.cycleLength) {
          return this.getRandomMotivation();
        }

        const phase = this.getCyclePhase(new Date());
        let motivationType, message, title;

        switch (phase.code) {
          case 'menstrual':
            motivationType = 'tip';
            title = 'Gentle Support for Menstrual Phase';
            message = this.getRandomTip();
            break;
          case 'follicular':
            motivationType = 'quote';
            title = 'Energy & Creativity for Follicular Phase';
            message = this.getRandomQuote();
            break;
          case 'ovulation':
            motivationType = 'psalm';
            title = 'Power & Confidence for Ovulation Phase';
            message = this.getRandomPsalm();
            break;
          case 'luteal':
            motivationType = 'tip';
            title = 'Calm Reflection for Luteal Phase';
            message = this.getRandomTip();
            break;
          default:
            return this.getRandomMotivation();
        }

        return { type: motivationType, message, title, phase: phase.name };
      }

      getRandomMotivation() {
        const types = ['quote', 'tip', 'psalm'];
        const type = types[Math.floor(Math.random() * types.length)];
        let message, title;

        switch (type) {
          case 'quote':
            title = 'Daily Inspiration';
            message = this.getRandomQuote();
            break;
          case 'tip':
            title = 'Wellness Tip';
            message = this.getRandomTip();
            break;
          case 'psalm':
            title = 'Spiritual Reflection';
            message = this.getRandomPsalm();
            break;
        }

        return { type, message, title };
      }

      getRandomQuote() {
        const quotes = [
          "Every day is a new beginning. Take a deep breath and start again.",
          "You are capable of amazing things. Believe in yourself.",
          "Progress is progress, no matter how small.",
          "Your strength is greater than any struggle.",
          "Today is your day to shine.",
          "You are stronger than you think.",
          "Keep going, you're doing great!",
          "Success is not final, failure is not fatal.",
          "Believe you can and you're halfway there.",
          "The future depends on what you do today."
        ];
        return quotes[Math.floor(Math.random() * quotes.length)];
      }

      getRandomTip() {
        const tips = [
          "Take deep breaths when feeling overwhelmed. Inhale for 4 counts, hold for 4, exhale for 4.",
          "Break large tasks into smaller, manageable steps. Celebrate each small victory.",
          "Practice gratitude by writing down 3 things you're thankful for each day.",
          "Stay hydrated - even mild dehydration can affect your mood and energy.",
          "Move your body daily, even if it's just a short walk around the block.",
          "Connect with loved ones regularly. Social support is crucial for mental health.",
          "Limit screen time before bed to improve sleep quality.",
          "Practice self-compassion. Treat yourself as you would treat a good friend.",
          "Learn to say no to things that don't align with your priorities.",
          "Create a morning routine that sets a positive tone for your day."
        ];
        return tips[Math.floor(Math.random() * tips.length)];
      }

      getRandomPsalm() {
        const psalms = [
          "The Lord is my shepherd, I shall not want. He makes me lie down in green pastures, he leads me beside quiet waters, he refreshes my soul.",
          "I lift up my eyes to the mountains—where does my help come from? My help comes from the Lord, the Maker of heaven and earth.",
          "The Lord is my light and my salvation—whom shall I fear? The Lord is the stronghold of my life—of whom shall I be afraid?",
          "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.",
          "I can do all this through him who gives me strength.",
          "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you, plans to give you hope and a future.",
          "Come to me, all you who are weary and burdened, and I will give you rest.",
          "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.",
          "The Lord is close to the brokenhearted and saves those who are crushed in spirit.",
          "Cast your cares on the Lord and he will sustain you; he will never let the righteous be shaken."
        ];
        return psalms[Math.floor(Math.random() * psalms.length)];
      }

      displayMotivation(motivation) {
        const titleEl = document.getElementById('motivationTitle');
        const messageEl = document.getElementById('motivationMessage');
        
        if (titleEl) titleEl.textContent = motivation.title;
        if (messageEl) {
          let html = '';
          
          if (motivation.phase) {
            html += `<div class="motivation-cycle">
              <h4>Current Cycle Phase: ${motivation.phase}</h4>
              <p>This message is tailored to support you during this phase.</p>
            </div>`;
          }
          
          html += `<div class="motivation-text">${motivation.message}</div>`;
          messageEl.innerHTML = html;
        }
      }

      nextMotivation() {
        this.currentMotivation = this.getCycleBasedMotivation();
        this.displayMotivation(this.currentMotivation);
      }

      saveMotivation() {
        if (!this.currentMotivation) return;
        
        // Save to custom affirmations
        if (!this.motivation.customAffirmations) {
          this.motivation.customAffirmations = [];
        }
        
        this.motivation.customAffirmations.unshift(this.currentMotivation.message);
        this.saveData();
        this.renderCustomAffirmations();
        
        this.showToast('Motivation saved to your affirmations!');
      }

      // ========= Calendar Day Editor =========
      editDayNote(date) {
        const modal = document.getElementById('dayEditorModal');
        const dateEl = document.getElementById('dayEditorDate');
        const textarea = document.getElementById('dayEditorTextarea');
        
        if (!modal || !dateEl || !textarea) {
          console.error('Day editor elements not found');
          return;
        }
        
        console.log('Opening day editor for:', date);
        
        // Format date for display
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateEl.textContent = date.toLocaleDateString('en-US', options);
        
        // Load existing note if any
        const dateKey = this.formatDate(date);
        const existingNote = this.getDayNote(dateKey);
        textarea.value = existingNote || '';
        
        // Store the current date being edited
        this.editingDate = dateKey;
        
        // Show modal with multiple approaches
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Force visibility
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        
        // Focus on textarea
        textarea.focus();
        console.log('Day editor modal should be visible now');
      }

      hideDayEditor() {
        const modal = document.getElementById('dayEditorModal');
        if (!modal) return;
        
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        this.editingDate = null;
      }

      saveDayNote() {
        if (!this.editingDate) return;
        
        const textarea = document.getElementById('dayEditorTextarea');
        if (!textarea) return;
        
        const note = textarea.value.trim();
        this.setDayNote(this.editingDate, note);
        
        // Update calendar display
        this.buildCalendar();
        
        // Hide modal
        this.hideDayEditor();
        
        // Show success message
        this.showToast(note ? 'Day note saved!' : 'Day note cleared!');
      }

      getDayNote(dateKey) {
        try {
          const notes = JSON.parse(localStorage.getItem('calendar_day_notes') || '{}');
          return notes[dateKey] || '';
        } catch {
          return '';
        }
      }

      setDayNote(dateKey, note) {
        try {
          const notes = JSON.parse(localStorage.getItem('calendar_day_notes') || '{}');
          if (note) {
            notes[dateKey] = note;
          } else {
            delete notes[dateKey];
          }
          localStorage.setItem('calendar_day_notes', JSON.stringify(notes));
        } catch (error) {
          console.error('Failed to save day note:', error);
        }
      }

      updateDayNoteIndicator(dayElement, date) {
        const dateKey = this.formatDate(date);
        const note = this.getDayNote(dateKey);
        
        if (note) {
          dayElement.classList.add('has-note');
          dayElement.title = `Note: ${note.substring(0, 50)}${note.length > 50 ? '...' : ''}`;
        } else {
          dayElement.classList.remove('has-note');
          dayElement.title = 'Double-click to add/edit note';
        }
      }

      openScheduleModal(task) {
        const modal = document.getElementById('scheduleModal');
        const dateInput = document.getElementById('scheduleDate');
        const timeInput = document.getElementById('scheduleTime');
        const textInput = document.getElementById('scheduleText');
        if (!modal || !dateInput || !timeInput || !textInput) return;
        this._schedulingTask = task;
        // Prefill with current selected date and task text
        dateInput.value = this.formatDate(this.selectedDate);
        timeInput.value = '';
        textInput.value = (task?.text || '').trim();
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      closeScheduleModal() {
        const modal = document.getElementById('scheduleModal');
        if (!modal) return;
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        this._schedulingTask = null;
      }

      saveScheduledTask() {
        const dateInput = document.getElementById('scheduleDate');
        const timeInput = document.getElementById('scheduleTime');
        const textInput = document.getElementById('scheduleText');
        if (!dateInput || !textInput) return;
        const dateKey = dateInput.value;
        if (!dateKey) { this.showToast('Pick a date first'); return; }
        const time = (timeInput.value || '').trim();
        const text = (textInput.value || '').trim();
        if (!text) { this.showToast('Write a task title'); return; }
        const bullet = time ? `- [ ] ${time} ${text}` : `- [ ] ${text}`;
        const existing = this.getDayNote(dateKey) || '';
        const newNote = existing ? `${existing}\n${bullet}` : bullet;
        this.setDayNote(dateKey, newNote);
        this.closeScheduleModal();
        this.showToast('Task added to calendar day');
        // If we scheduled to current month, refresh calendar
        this.buildCalendar();
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      new DigitalPlanner();
    });
  </script>
  
  <!-- Premium loader removed: local Motivation implemented -->
</body>
</html>